// Drill-Down Modal Component (Story 4.1 + 4.2 + 4.4)
// Displays message cryptographic details in a modal overlay
//
// Properties:
//   - is_visible: Controls whether the modal is displayed
//   - sender_key: Full sender public key to display
//   - message_content: The message text
//   - timestamp: Message timestamp (formatted)
//   - signature: Full cryptographic signature (hex-encoded)
//   - is_verified: Verification status (true = verified, false = failed)
//   - key_copied: Temporary state for copy button feedback (true = shows "Copied!")
//   - message_copied: Temporary state for copy button feedback
//   - signature_copied: Temporary state for copy button feedback
//
// Callbacks:
//   - close_requested: Triggered when user presses Escape or clicks X
//   - copy_key: Triggered when user clicks copy button for public key
//   - copy_message: Triggered when user clicks copy button for message content
//   - copy_signature: Triggered when user clicks copy button for signature
//
// Features:
//   - Centered modal overlay
//   - Dimmed background (50% opacity overlay)
//   - Close button (X) in top-right corner
//   - Escape key closes modal
//   - Focus trapping within modal
//   - Backdrop click closes modal
//   - Copy buttons with visual feedback ("Copied!" for 1 second)
//
// Color System:
//   - Modal background: #1e1e2e (dark surface)
//   - Overlay background: #000000 with 50% opacity
//   - Text primary: #ffffff
//   - Text secondary: #a0a0a0
//   - Public key: #0066CC (blue)
//   - Signature text: #6b7280 (neutral gray)
//   - Verified badge: #22c55e (green)
//   - Warning badge: #ef4444 (red)
//   - Close button: #ef4444 (red) on hover
//   - Copy button: #6b7280 (gray), changes to #22c55e (green) when copied
//
// Signature Format (Story 4.4 - Technical Testing & Validation):
//   - Algorithm: Ed25519 (EdDSA with Curve25519)
//   - Key size: 256-bit (32 bytes)
//   - Signature size: 512-bit (64 bytes = 128 hex characters)
//   - Encoding: Hexadecimal (lowercase, 0-9, a-f)
//   - Font: Monospace (Consolas, Monaco, or system monospace)
//   - Display: Full 128 characters, word-wrapped for readability
//   - Purpose: Enables technical users to verify cryptographic correctness
//
// Example signature (64 bytes = 128 hex chars):
//   a4f3e2c1b8d5e9f2a7c4d8e1f3b6a9d2c8e7f1a3b5d8c7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b1c0d
//
// For technical validation:
//   - Same message + same key = identical signature (deterministic)
//   - Different messages produce different signatures (no collisions)
//   - Ed25519 is deterministic per RFC 8032

export component DrillDownModal {
    in property <bool> is_visible: false;

    // Message details to display (populated in Story 4.2)
    in property <string> sender_key: "";
    in property <string> message_content: "";
    in property <string> timestamp: "";
    in property <string> signature: "";
    in property <bool> is_verified: false;

    // Verification badge text
    in property <string> verification_text: "";
    in property <string> verification_explanation: "";

    // Copy button feedback states
    in property <bool> key_copied: false;
    in property <bool> message_copied: false;
    in property <bool> signature_copied: false;
    in property <bool> key_error: false;
    in property <bool> message_error: false;
    in property <bool> signature_error: false;

    callback close_requested;
    callback copy_key;
    callback copy_message;
    callback copy_signature;

    // Focus management for keyboard navigation
    forward-focus: modal_scope;

    // Modal container - only visible when is_visible property is true
    Rectangle {
        visible: root.is_visible;

        // Dimmed overlay (backdrop)
        Rectangle {
            width: parent.width;
            height: parent.height;
            background: #000000;
            opacity: 0.5;

            // Click outside to close (backdrop click)
            TouchArea {
                clicked => {
                    root.close_requested();
                }
            }
        }

        // Modal content (centered)
        modal_scope := FocusScope {
            x: (parent.width - 500px) / 2;
            y: (parent.height - 400px) / 2;
            width: 500px;
            height: 400px;

            // Keyboard event handling (Escape to close)
            key-pressed(event) => {
                // Check for Escape key using modifier + key combination
                // Escape key typically sends an empty text with no modifiers
                if (event.text == "" && !event.modifiers.alt && !event.modifiers.control && !event.modifiers.shift) {
                    root.close_requested();
                    return accept;
                }
                return reject;
            }

            // Modal background
            Rectangle {
                width: parent.width;
                height: parent.height;
                background: #1e1e2e;
                border-radius: 12px;
                border-width: 1px;
                border-color: #3d3d5c;

                // Header with title and close button
                VerticalLayout {
                    padding: 16px;
                    padding-bottom: 0px;
                    spacing: 12px;

                    // Header row: Title + Close button
                    HorizontalLayout {
                        spacing: 8px;

                        Text {
                            text: "Message Details";
                            font-size: 18px;
                            font-weight: 700;
                            color: #ffffff;
                            vertical-alignment: center;
                        }

                        // Spacer to push close button to right
                        Rectangle {
                            width: 1px;
                            horizontal-stretch: 1;
                        }

                        // Close button (X)
                        close_button := FocusScope {
                            width: 32px;
                            height: 32px;

                            Rectangle {
                                width: parent.width;
                                height: parent.height;
                                background: close_button.has-focus ? #cc4444 : #ef4444;
                                border-radius: 6px;
                                border-width: close_button.has-focus ? 2px : 0px;
                                border-color: #ff6666;

                                Text {
                                    text: "✕";
                                    color: #ffffff;
                                    font-size: 16px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }

                            TouchArea {
                                width: parent.width;
                                height: parent.height;
                                clicked => {
                                    root.close_requested();
                                }
                            }

                            accessible-role: button;
                            accessible-label: "Close message details";
                            accessible-description: "Press Enter, Space, or click to close the modal";

                            key-pressed(event) => {
                                if (event.text == "\n" || event.text == " ") {
                                    root.close_requested();
                                    return accept;
                                }
                                return reject;
                            }
                        }
                    }

                    // Divider
                    Rectangle {
                        height: 1px;
                        background: #3d3d5c;
                    }
                }

                // Scrollable content area using Flickable
                Flickable {
                    vertical-stretch: 1;
                    horizontal-stretch: 0;

                    // Content area with copy buttons (Story 4.2)
                    VerticalLayout {
                        padding: 16px;
                        padding-top: 12px;
                        spacing: 12px;

                        // Sender's public key (Layer 1 - Always visible)
                        VerticalLayout {
                            spacing: 4px;

                            // Header with label and copy button
                            HorizontalLayout {
                                spacing: 8px;

                                Text {
                                    text: "Sender's Public Key";
                                    font-size: 12px;
                                    color: #a0a0a0;
                                    font-weight: 600;
                                    vertical-alignment: center;
                                }

                                // Copy button for public key
                                key_copy_button := FocusScope {
                                    width: 60px;
                                    height: 20px;

                                    Rectangle {
                                        width: parent.width;
                                        height: parent.height;
                                        background: key_copy_button.has-focus ? #4444AA : (root.key_error ? #ef4444 : (root.key_copied ? #22c55e : #333333));
                                        border-radius: 4px;
                                        border-width: key_copy_button.has-focus ? 2px : 0px;
                                        border-color: key_copy_button.has-focus ? #6666CC : transparent;

                                        Text {
                                            text: {
                                                if (root.key_error) { "Error!" }
                                                else if (root.key_copied) { "Copied!" }
                                                else { "Copy" }
                                            };
                                            color: #ffffff;
                                            font-size: 10px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }

                                    TouchArea {
                                        width: parent.width;
                                        height: parent.height;
                                        mouse-cursor: pointer;

                                        clicked => {
                                            root.copy_key();
                                        }
                                    }

                                    key-pressed(event) => {
                                        if (event.text == "\n" || event.text == " ") {
                                            root.copy_key();
                                            return accept;
                                        }
                                        return reject;
                                    }
                                }
                            }

                            Text {
                                text: root.sender_key;
                                font-family: "Consolas, Monaco, monospace";
                                font-size: 11px;
                                color: #0066CC;
                                wrap: word-wrap;
                                horizontal-alignment: left;
                            }
                        }

                        // Message content (Layer 1 - Always visible)
                        VerticalLayout {
                            spacing: 4px;

                            // Header with label and copy button
                            HorizontalLayout {
                                spacing: 8px;

                                Text {
                                    text: "Message";
                                    font-size: 12px;
                                    color: #a0a0a0;
                                    font-weight: 600;
                                    vertical-alignment: center;
                                }

                                // Copy button for message
                                message_copy_button := FocusScope {
                                    width: 60px;
                                    height: 20px;

                                    Rectangle {
                                        width: parent.width;
                                        height: parent.height;
                                        background: message_copy_button.has-focus ? #4444AA : (root.message_error ? #ef4444 : (root.message_copied ? #22c55e : #333333));
                                        border-radius: 4px;
                                        border-width: message_copy_button.has-focus ? 2px : 0px;
                                        border-color: message_copy_button.has-focus ? #6666CC : transparent;

                                        Text {
                                            text: {
                                                if (root.message_error) { "Error!" }
                                                else if (root.message_copied) { "Copied!" }
                                                else { "Copy" }
                                            };
                                            color: #ffffff;
                                            font-size: 10px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }

                                    TouchArea {
                                        width: parent.width;
                                        height: parent.height;
                                        mouse-cursor: pointer;

                                        clicked => {
                                            root.copy_message();
                                        }
                                    }

                                    key-pressed(event) => {
                                        if (event.text == "\n" || event.text == " ") {
                                            root.copy_message();
                                            return accept;
                                        }
                                        return reject;
                                    }
                                }
                            }

                            Text {
                                text: root.message_content;
                                font-size: 14px;
                                color: #ffffff;
                                wrap: word-wrap;
                                horizontal-alignment: left;
                            }
                        }

                        // Timestamp (Layer 1 - Always visible)
                        VerticalLayout {
                            spacing: 4px;

                            Text {
                                text: "Timestamp";
                                font-size: 12px;
                                color: #a0a0a0;
                                font-weight: 600;
                            }

                            Text {
                                text: root.timestamp;
                                font-size: 12px;
                                color: #888888;
                            }
                        }

                        // Verification status (Layer 3)
                        VerticalLayout {
                            spacing: 8px;
                            padding-top: 8px;

                            HorizontalLayout {
                                spacing: 8px;

                                // Verification badge
                                Rectangle {
                                    width: 24px;
                                    height: 24px;
                                    border-radius: 12px;
                                    background: root.is_verified ? #dcfce7 : #fef2f2;

                                    Text {
                                        text: root.is_verified ? "✓" : "⚠";
                                        color: #ffffff;
                                        font-size: 14px;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }

                                Text {
                                    text: root.verification_text;
                                    font-size: 14px;
                                    font-weight: 600;
                                    color: root.is_verified ? #166534 : #991b1b;
                                    vertical-alignment: center;
                                }
                            }

                            Text {
                                text: root.verification_explanation;
                                font-size: 12px;
                                color: #a0a0a0;
                                wrap: word-wrap;
                                horizontal-alignment: left;
                            }
                        }

                        // Cryptographic Signature (Layer 2)
                        VerticalLayout {
                            spacing: 4px;
                            padding-top: 8px;

                            // Header with label and copy button
                            HorizontalLayout {
                                spacing: 8px;

                                Text {
                                    text: "Cryptographic Signature";
                                    font-size: 12px;
                                    color: #a0a0a0;
                                    font-weight: 600;
                                    vertical-alignment: center;
                                }

                                // Copy button for signature
                                signature_copy_button := FocusScope {
                                    width: 60px;
                                    height: 20px;

                                    Rectangle {
                                        width: parent.width;
                                        height: parent.height;
                                        background: signature_copy_button.has-focus ? #4444AA : (root.signature_error ? #ef4444 : (root.signature_copied ? #22c55e : #333333));
                                        border-radius: 4px;
                                        border-width: signature_copy_button.has-focus ? 2px : 0px;
                                        border-color: signature_copy_button.has-focus ? #6666CC : transparent;

                                        Text {
                                            text: {
                                                if (root.signature_error) { "Error!" }
                                                else if (root.signature_copied) { "Copied!" }
                                                else { "Copy" }
                                            };
                                            color: #ffffff;
                                            font-size: 10px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }

                                    TouchArea {
                                        width: parent.width;
                                        height: parent.height;
                                        mouse-cursor: pointer;

                                        clicked => {
                                            root.copy_signature();
                                        }
                                    }

                                    key-pressed(event) => {
                                        if (event.text == "\n" || event.text == " ") {
                                            root.copy_signature();
                                            return accept;
                                        }
                                        return reject;
                                    }
                                }
                            }

                            Text {
                                // Signature Display (Story 4.4 - Technical Testing)
                                // Shows full 128-character Ed25519 signature in hex format
                                // - Monospace font for readability and technical accuracy
                                // - Neutral gray color (#6b7280) for technical data
                                // - Word-wrap enabled for long signatures
                                // - Consistent lowercase hex format for comparison
                                text: root.signature;
                                font-family: "Consolas, Monaco, monospace";
                                font-size: 10px;
                                color: #6b7280;
                                wrap: word-wrap;
                                horizontal-alignment: left;
                            }
                        }
                    }
                }
            }
        }
    }
}
