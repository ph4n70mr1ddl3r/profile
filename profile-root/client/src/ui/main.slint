import { WelcomeScreen } from "welcome_screen.slint";
import { KeyDisplay } from "key_display.slint";
import { ImportKeyScreen } from "import_key_screen.slint";

export component AppWindow inherits Window {
    title: "Profile - Cryptographic Messaging";
    width: 800px;
    height: 600px;
    
    // Application state properties (updated from Rust)
    in property <bool> key_generated: false;
    in property <string> public_key_display: "";
    in property <string> status_message: "";
    in property <bool> copy_feedback_visible: false;
    in property <bool> status_is_error: false;
    
    // View state: "welcome", "import", "key-display"
    in-out property <string> current_view: "welcome";
    
    // Import screen state
    // Security note: This stores user input temporarily as a Slint string.
    // It is cleared immediately after import in main.rs callbacks:
    //   - show_import_screen (clears on navigation to import view)
    //   - import_key_attempt (clears after successful import)
    //   - cancel_import (clears on return to welcome screen)
    // Cannot be cryptographically zeroized (Slint string limitation).
    // The decoded key IS zeroized in Rust after hex::decode().
    in-out property <string> import_key_input: "";
    in property <string> import_error_message: "";
    in property <bool> show_import_error: false;
    
    // Callbacks that trigger Rust handlers
    callback generate_key_pressed;
    callback show_import_screen;
    callback import_key_attempt(string);
    callback cancel_import;
    callback copy_public_key;

    Rectangle {
        background: #1a1a2e;

        // Welcome screen (initial view)
        WelcomeScreen {
            visible: root.current_view == "welcome";
            status_message: root.status_message;
            generate_key_pressed => {
                root.generate_key_pressed();
            }
            import_key_pressed => {
                root.show_import_screen();
            }
        }

        // Import key screen
        ImportKeyScreen {
            visible: root.current_view == "import";
            key_input <=> root.import_key_input;
            error_message: root.import_error_message;
            show_error: root.show_import_error;
            import_pressed(key) => {
                root.import_key_attempt(key);
            }
            cancel_pressed => {
                root.cancel_import();
            }
        }

        // Key display (after successful generation or import)
        VerticalLayout {
            visible: root.current_view == "key-display";
            padding: 32px;
            spacing: 16px;

            Text {
                text: "Your Cryptographic Identity";
                font-size: 24px;
                color: #ffffff;
                font-weight: 700;
            }

            KeyDisplay {
                public_key: root.public_key_display;
                show_label: true;
                allow_copy: true;
                show_copy_feedback: root.copy_feedback_visible;
                copy_pressed => {
                    root.copy_public_key();
                }
            }

            Text {
                visible: root.status_message != "";
                text: root.status_message;
                font-size: 12px;
                color: root.status_is_error ? #ff4444 : #4cd137;
            }

            Text {
                text: "Ready to connect and send messages";
                font-size: 12px;
                color: #999999;
            }
        }
    }
}
