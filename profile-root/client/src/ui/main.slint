import { WelcomeScreen } from "welcome_screen.slint";
import { KeyDisplay } from "key_display.slint";
import { ImportKeyScreen } from "import_key_screen.slint";
import { LobbyItem } from "lobby_item.slint";
import { MessageComposer } from "composer.slint";
import { DrillDownModal } from "drill_down_modal.slint";
import { MessageItem } from "message_item.slint";

export component AppWindow inherits Window {
    title: "Profile - Cryptographic Messaging";
    width: 800px;
    height: 600px;

    // Application state properties (updated from Rust)
    in property <bool> key_generated: false;
    in property <string> public_key_display: "";
    in property <string> status_message: "";
    in property <bool> copy_feedback_visible: false;
    in property <bool> status_is_error: false;

    // View state: "welcome", "import", "key-display", "lobby"
    in-out property <string> current_view: "welcome";

    // Import screen state
    // Security note: This stores user input temporarily as a Slint string.
    // It is cleared immediately after import in main.rs callbacks:
    //   - show_import_screen (clears on navigation to import view)
    //   - import_key_attempt (clears after successful import)
    //   - cancel_import (clears on return to welcome screen)
    // Cannot be cryptographically zeroized (Slint string limitation).
    // The decoded key IS zeroized in Rust after hex::decode().
    in-out property <string> import_key_input: "";
    in property <string> import_error_message: "";
    in property <bool> show_import_error: false;

    // Lobby state (Story 2.2)
    in property <bool> lobby_visible: false;
    in property <string> lobby_selected_user: "";
    in property <int> lobby_user_count: 0;
    in property <bool> composer_focused: false;

    // Composer state (Story 3.1)
    in property <string> composer_recipient: "";
    in property <string> composer_message_text: "";
    in property <bool> composer_can_send: false;
    in property <bool> composer_message_text_focused: false;

    // Lobby user slot properties (up to 5 users shown for MVP)
    // Each slot has: public_key, is_online, is_selected
    in property <string> lobby_user_1_public_key: "";
    in property <bool> lobby_user_1_online: true;
    in property <bool> lobby_user_1_selected: false;

    in property <string> lobby_user_2_public_key: "";
    in property <bool> lobby_user_2_online: true;
    in property <bool> lobby_user_2_selected: false;

    in property <string> lobby_user_3_public_key: "";
    in property <bool> lobby_user_3_online: true;
    in property <bool> lobby_user_3_selected: false;

    in property <string> lobby_user_4_public_key: "";
    in property <bool> lobby_user_4_online: true;
    in property <bool> lobby_user_4_selected: false;

    in property <string> lobby_user_5_public_key: "";
    in property <bool> lobby_user_5_online: true;
    in property <bool> lobby_user_5_selected: false;

    // Chat message slot properties (up to 10 messages for MVP)
    // Story 4.1: Fixed slots since Slint 1.5 doesn't support dynamic for-each
    in property <int> chat_message_count: 0;

    in property <string> chat_msg_1_sender_key: "";
    in property <string> chat_msg_1_sender_key_short: "";
    in property <string> chat_msg_1_content: "";
    in property <string> chat_msg_1_timestamp: "";
    in property <string> chat_msg_1_signature: "";
    in property <bool> chat_msg_1_is_self: false;
    in property <bool> chat_msg_1_is_verified: true;

    in property <string> chat_msg_2_sender_key: "";
    in property <string> chat_msg_2_sender_key_short: "";
    in property <string> chat_msg_2_content: "";
    in property <string> chat_msg_2_timestamp: "";
    in property <string> chat_msg_2_signature: "";
    in property <bool> chat_msg_2_is_self: false;
    in property <bool> chat_msg_2_is_verified: true;

    in property <string> chat_msg_3_sender_key: "";
    in property <string> chat_msg_3_sender_key_short: "";
    in property <string> chat_msg_3_content: "";
    in property <string> chat_msg_3_timestamp: "";
    in property <string> chat_msg_3_signature: "";
    in property <bool> chat_msg_3_is_self: false;
    in property <bool> chat_msg_3_is_verified: true;

    in property <string> chat_msg_4_sender_key: "";
    in property <string> chat_msg_4_sender_key_short: "";
    in property <string> chat_msg_4_content: "";
    in property <string> chat_msg_4_timestamp: "";
    in property <string> chat_msg_4_signature: "";
    in property <bool> chat_msg_4_is_self: false;
    in property <bool> chat_msg_4_is_verified: true;

    in property <string> chat_msg_5_sender_key: "";
    in property <string> chat_msg_5_sender_key_short: "";
    in property <string> chat_msg_5_content: "";
    in property <string> chat_msg_5_timestamp: "";
    in property <string> chat_msg_5_signature: "";
    in property <bool> chat_msg_5_is_self: false;
    in property <bool> chat_msg_5_is_verified: true;

    in property <string> chat_msg_6_sender_key: "";
    in property <string> chat_msg_6_sender_key_short: "";
    in property <string> chat_msg_6_content: "";
    in property <string> chat_msg_6_timestamp: "";
    in property <string> chat_msg_6_signature: "";
    in property <bool> chat_msg_6_is_self: false;
    in property <bool> chat_msg_6_is_verified: true;

    in property <string> chat_msg_7_sender_key: "";
    in property <string> chat_msg_7_sender_key_short: "";
    in property <string> chat_msg_7_content: "";
    in property <string> chat_msg_7_timestamp: "";
    in property <string> chat_msg_7_signature: "";
    in property <bool> chat_msg_7_is_self: false;
    in property <bool> chat_msg_7_is_verified: true;

    in property <string> chat_msg_8_sender_key: "";
    in property <string> chat_msg_8_sender_key_short: "";
    in property <string> chat_msg_8_content: "";
    in property <string> chat_msg_8_timestamp: "";
    in property <string> chat_msg_8_signature: "";
    in property <bool> chat_msg_8_is_self: false;
    in property <bool> chat_msg_8_is_verified: true;

    in property <string> chat_msg_9_sender_key: "";
    in property <string> chat_msg_9_sender_key_short: "";
    in property <string> chat_msg_9_content: "";
    in property <string> chat_msg_9_timestamp: "";
    in property <string> chat_msg_9_signature: "";
    in property <bool> chat_msg_9_is_self: false;
    in property <bool> chat_msg_9_is_verified: true;

    in property <string> chat_msg_10_sender_key: "";
    in property <string> chat_msg_10_sender_key_short: "";
    in property <string> chat_msg_10_content: "";
    in property <string> chat_msg_10_timestamp: "";
    in property <string> chat_msg_10_signature: "";
    in property <bool> chat_msg_10_is_self: false;
    in property <bool> chat_msg_10_is_verified: true;

    // Drill-down modal state (Story 4.1)
    in property <bool> drill_down_modal_visible: false;
    in property <string> drill_down_sender_key: "";
    in property <string> drill_down_message_content: "";
    in property <string> drill_down_timestamp: "";
    in property <string> drill_down_signature: "";
    in property <bool> drill_down_is_verified: true;
    in property <string> drill_down_verification_text: "";
    in property <string> drill_down_verification_explanation: "";

    // Drill-down modal copy button states (Story 4.2)
    in property <bool> drill_down_key_copied: false;
    in property <bool> drill_down_message_copied: false;
    in property <bool> drill_down_signature_copied: false;
    in property <bool> drill_down_key_error: false;
    in property <bool> drill_down_message_error: false;
    in property <bool> drill_down_signature_error: false;

    // Drill-down modal copy callbacks (Story 4.2)
    callback drill_down_copy_key;
    callback drill_down_copy_message;
    callback drill_down_copy_signature;

    // Callbacks that trigger Rust handlers
    callback generate_key_pressed;
    callback show_import_screen;
    callback import_key_attempt(string);
    callback cancel_import;
    callback copy_public_key;

    // Composer callbacks (Story 3.1)
    callback composer_send_message(string);
    callback composer_enter_pressed();

    // Lobby callbacks (Story 2.2)
    callback lobby_user_selected(string);
    callback lobby_navigate_up;
    callback lobby_navigate_down;
    callback lobby_activate_selection;

    // Chat message callbacks (Story 4.1)
    callback chat_message_clicked(int);
    callback drill_down_modal_close;

    Rectangle {
        background: #1a1a2e;

        // Welcome screen (initial view)
        WelcomeScreen {
            visible: root.current_view == "welcome";
            status_message: root.status_message;
            generate_key_pressed => {
                root.generate_key_pressed();
            }
            import_key_pressed => {
                root.show_import_screen();
            }
        }

        // Import key screen
        ImportKeyScreen {
            visible: root.current_view == "import";
            key_input <=> root.import_key_input;
            error_message: root.import_error_message;
            show_error: root.show_import_error;
            import_pressed(key) => {
                root.import_key_attempt(key);
            }
            cancel_pressed => {
                root.cancel_import();
            }
        }

        // Key display (after successful generation or import)
        VerticalLayout {
            visible: root.current_view == "key-display";
            padding: 32px;
            spacing: 16px;

            Text {
                text: "Your Cryptographic Identity";
                font-size: 24px;
                color: #ffffff;
                font-weight: 700;
            }

            KeyDisplay {
                public_key: root.public_key_display;
                show_label: true;
                allow_copy: true;
                show_copy_feedback: root.copy_feedback_visible;
                copy_pressed => {
                    root.copy_public_key();
                }
            }

            Text {
                visible: root.status_message != "";
                text: root.status_message;
                font-size: 12px;
                color: root.status_is_error ? #ff4444 : #4cd137;
            }

            Text {
                text: "Ready to connect and send messages";
                font-size: 12px;
                color: #999999;
            }
        }

        // Lobby view (Story 2.2 - Online User List)
        VerticalLayout {
            visible: root.current_view == "lobby";
            padding: 16px;
            spacing: 8px;

            Text {
                text: "Online Users";
                font-size: 18px;
                color: #ffffff;
                font-weight: 600;
            }

            Text {
                visible: root.lobby_user_count == 0;
                text: "No users online";
                font-size: 14px;
                color: #999999;
                height: 100px;
                vertical-alignment: center;
                horizontal-alignment: center;
            }

            // Lobby list container (fixed slots for up to 5 users)
            // Note: Slint 1.5 doesn't support dynamic for-each loops,
            // so we use fixed slots with visibility control.
            Rectangle {
                visible: root.lobby_user_count > 0;
                background: #111827;
                border-radius: 4px;
                height: 400px;

                VerticalLayout {
                    padding: 8px;

                    // Lobby user slots (up to 5 users for MVP)
                    // Each slot is bound to Rust-side properties
                    // Slot 1
                    LobbyItem {
                        visible: root.lobby_user_count >= 1;
                        public_key: root.lobby_user_1_public_key;
                        is_online: root.lobby_user_1_online;
                        is_selected: root.lobby_user_1_selected;
                        clicked => {
                            root.lobby_user_selected(root.lobby_user_1_public_key);
                        }
                    }

                    // Slot 2
                    LobbyItem {
                        visible: root.lobby_user_count >= 2;
                        public_key: root.lobby_user_2_public_key;
                        is_online: root.lobby_user_2_online;
                        is_selected: root.lobby_user_2_selected;
                        clicked => {
                            root.lobby_user_selected(root.lobby_user_2_public_key);
                        }
                    }

                    // Slot 3
                    LobbyItem {
                        visible: root.lobby_user_count >= 3;
                        public_key: root.lobby_user_3_public_key;
                        is_online: root.lobby_user_3_online;
                        is_selected: root.lobby_user_3_selected;
                        clicked => {
                            root.lobby_user_selected(root.lobby_user_3_public_key);
                        }
                    }

                    // Slot 4
                    LobbyItem {
                        visible: root.lobby_user_count >= 4;
                        public_key: root.lobby_user_4_public_key;
                        is_online: root.lobby_user_4_online;
                        is_selected: root.lobby_user_4_selected;
                        clicked => {
                            root.lobby_user_selected(root.lobby_user_4_public_key);
                        }
                    }

                    // Slot 5
                    LobbyItem {
                        visible: root.lobby_user_count >= 5;
                        public_key: root.lobby_user_5_public_key;
                        is_online: root.lobby_user_5_online;
                        is_selected: root.lobby_user_5_selected;
                        clicked => {
                            root.lobby_user_selected(root.lobby_user_5_public_key);
                        }
                    }
                }
            }

            Text {
                visible: root.lobby_selected_user != "";
                text: "Selected: " + root.lobby_selected_user;
                font-size: 12px;
                color: #0066CC;
            }

            // Composer (Story 3.1)
            MessageComposer {
                visible: root.current_view == "lobby" || root.current_view == "chat";
                recipient: root.composer_recipient;
                focused: root.composer_message_text_focused;
                message_text: root.composer_message_text;
                send_message(text) => {
                    root.composer_send_message(text);
                }
                enter_pressed() => {
                    root.composer_enter_pressed();
                }
            }

            // Chat messages display area (Story 4.1 - message slots)
            Rectangle {
                visible: root.chat_message_count > 0;
                background: #0f0f1a;
                border-radius: 4px;
                height: 320px;

                VerticalLayout {
                    padding: 8px;
                    spacing: 6px;

                    // Chat message slots (up to 10 for MVP)
                    MessageItem {
                        visible: root.chat_message_count >= 1;
                        sender_key: root.chat_msg_1_sender_key;
                        sender_key_short: root.chat_msg_1_sender_key_short;
                        message_content: root.chat_msg_1_content;
                        timestamp: root.chat_msg_1_timestamp;
                        is_self: root.chat_msg_1_is_self;
                        is_verified: root.chat_msg_1_is_verified;
                        clicked => {
                            root.chat_message_clicked(1);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 2;
                        sender_key: root.chat_msg_2_sender_key;
                        sender_key_short: root.chat_msg_2_sender_key_short;
                        message_content: root.chat_msg_2_content;
                        timestamp: root.chat_msg_2_timestamp;
                        is_self: root.chat_msg_2_is_self;
                        is_verified: root.chat_msg_2_is_verified;
                        clicked => {
                            root.chat_message_clicked(2);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 3;
                        sender_key: root.chat_msg_3_sender_key;
                        sender_key_short: root.chat_msg_3_sender_key_short;
                        message_content: root.chat_msg_3_content;
                        timestamp: root.chat_msg_3_timestamp;
                        is_self: root.chat_msg_3_is_self;
                        is_verified: root.chat_msg_3_is_verified;
                        clicked => {
                            root.chat_message_clicked(3);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 4;
                        sender_key: root.chat_msg_4_sender_key;
                        sender_key_short: root.chat_msg_4_sender_key_short;
                        message_content: root.chat_msg_4_content;
                        timestamp: root.chat_msg_4_timestamp;
                        is_self: root.chat_msg_4_is_self;
                        is_verified: root.chat_msg_4_is_verified;
                        clicked => {
                            root.chat_message_clicked(4);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 5;
                        sender_key: root.chat_msg_5_sender_key;
                        sender_key_short: root.chat_msg_5_sender_key_short;
                        message_content: root.chat_msg_5_content;
                        timestamp: root.chat_msg_5_timestamp;
                        is_self: root.chat_msg_5_is_self;
                        is_verified: root.chat_msg_5_is_verified;
                        clicked => {
                            root.chat_message_clicked(5);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 6;
                        sender_key: root.chat_msg_6_sender_key;
                        sender_key_short: root.chat_msg_6_sender_key_short;
                        message_content: root.chat_msg_6_content;
                        timestamp: root.chat_msg_6_timestamp;
                        is_self: root.chat_msg_6_is_self;
                        is_verified: root.chat_msg_6_is_verified;
                        clicked => {
                            root.chat_message_clicked(6);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 7;
                        sender_key: root.chat_msg_7_sender_key;
                        sender_key_short: root.chat_msg_7_sender_key_short;
                        message_content: root.chat_msg_7_content;
                        timestamp: root.chat_msg_7_timestamp;
                        is_self: root.chat_msg_7_is_self;
                        is_verified: root.chat_msg_7_is_verified;
                        clicked => {
                            root.chat_message_clicked(7);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 8;
                        sender_key: root.chat_msg_8_sender_key;
                        sender_key_short: root.chat_msg_8_sender_key_short;
                        message_content: root.chat_msg_8_content;
                        timestamp: root.chat_msg_8_timestamp;
                        is_self: root.chat_msg_8_is_self;
                        is_verified: root.chat_msg_8_is_verified;
                        clicked => {
                            root.chat_message_clicked(8);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 9;
                        sender_key: root.chat_msg_9_sender_key;
                        sender_key_short: root.chat_msg_9_sender_key_short;
                        message_content: root.chat_msg_9_content;
                        timestamp: root.chat_msg_9_timestamp;
                        is_self: root.chat_msg_9_is_self;
                        is_verified: root.chat_msg_9_is_verified;
                        clicked => {
                            root.chat_message_clicked(9);
                        }
                    }

                    MessageItem {
                        visible: root.chat_message_count >= 10;
                        sender_key: root.chat_msg_10_sender_key;
                        sender_key_short: root.chat_msg_10_sender_key_short;
                        message_content: root.chat_msg_10_content;
                        timestamp: root.chat_msg_10_timestamp;
                        is_self: root.chat_msg_10_is_self;
                        is_verified: root.chat_msg_10_is_verified;
                        clicked => {
                            root.chat_message_clicked(10);
                        }
                    }
                }
            }
        }

        // Drill-down modal overlay (Story 4.1)
        // Placed at end of Rectangle to render on top of other content
        DrillDownModal {
            is_visible: root.drill_down_modal_visible;
            sender_key: root.drill_down_sender_key;
            message_content: root.drill_down_message_content;
            timestamp: root.drill_down_timestamp;
            signature: root.drill_down_signature;
            is_verified: root.drill_down_is_verified;
            verification_text: root.drill_down_verification_text;
            verification_explanation: root.drill_down_verification_explanation;
            key_copied: root.drill_down_key_copied;
            message_copied: root.drill_down_message_copied;
            signature_copied: root.drill_down_signature_copied;
            key_error: root.drill_down_key_error;
            message_error: root.drill_down_message_error;
            signature_error: root.drill_down_signature_error;

            close_requested => {
                root.drill_down_modal_close();
            }

            copy_key => {
                root.drill_down_copy_key();
            }

            copy_message => {
                root.drill_down_copy_message();
            }

            copy_signature => {
                root.drill_down_copy_signature();
            }
        }
    }
}
