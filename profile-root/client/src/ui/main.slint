import { WelcomeScreen } from "welcome_screen.slint";
import { KeyDisplay } from "key_display.slint";
import { ImportKeyScreen } from "import_key_screen.slint";
import { LobbyItem } from "lobby_item.slint";
import { MessageComposer } from "composer.slint";

export component AppWindow inherits Window {
    title: "Profile - Cryptographic Messaging";
    width: 800px;
    height: 600px;
    
    // Application state properties (updated from Rust)
    in property <bool> key_generated: false;
    in property <string> public_key_display: "";
    in property <string> status_message: "";
    in property <bool> copy_feedback_visible: false;
    in property <bool> status_is_error: false;
    
    // View state: "welcome", "import", "key-display", "lobby"
    in-out property <string> current_view: "welcome";
    
    // Import screen state
    // Security note: This stores user input temporarily as a Slint string.
    // It is cleared immediately after import in main.rs callbacks:
    //   - show_import_screen (clears on navigation to import view)
    //   - import_key_attempt (clears after successful import)
    //   - cancel_import (clears on return to welcome screen)
    // Cannot be cryptographically zeroized (Slint string limitation).
    // The decoded key IS zeroized in Rust after hex::decode().
    in-out property <string> import_key_input: "";
    in property <string> import_error_message: "";
    in property <bool> show_import_error: false;

    // Lobby state (Story 2.2)
    in property <bool> lobby_visible: false;
    in property <string> lobby_selected_user: "";
    in property <int> lobby_user_count: 0;
    in property <bool> composer_focused: false;

    // Lobby user slot properties (up to 5 users shown for MVP)
    // Each slot has: public_key, is_online, is_selected
    in property <string> lobby_user_1_public_key: "";
    in property <bool> lobby_user_1_online: true;
    in property <bool> lobby_user_1_selected: false;

    in property <string> lobby_user_2_public_key: "";
    in property <bool> lobby_user_2_online: true;
    in property <bool> lobby_user_2_selected: false;

    in property <string> lobby_user_3_public_key: "";
    in property <bool> lobby_user_3_online: true;
    in property <bool> lobby_user_3_selected: false;

    in property <string> lobby_user_4_public_key: "";
    in property <bool> lobby_user_4_online: true;
    in property <bool> lobby_user_4_selected: false;

    in property <string> lobby_user_5_public_key: "";
    in property <bool> lobby_user_5_online: true;
    in property <bool> lobby_user_5_selected: false;
    
    // Callbacks that trigger Rust handlers
    callback generate_key_pressed;
    callback show_import_screen;
    callback import_key_attempt(string);
    callback cancel_import;
    callback copy_public_key;

    // Lobby callbacks (Story 2.2)
    callback lobby_user_selected(string);
    callback lobby_navigate_up;
    callback lobby_navigate_down;
    callback lobby_activate_selection;

    Rectangle {
        background: #1a1a2e;

        // Welcome screen (initial view)
        WelcomeScreen {
            visible: root.current_view == "welcome";
            status_message: root.status_message;
            generate_key_pressed => {
                root.generate_key_pressed();
            }
            import_key_pressed => {
                root.show_import_screen();
            }
        }

        // Import key screen
        ImportKeyScreen {
            visible: root.current_view == "import";
            key_input <=> root.import_key_input;
            error_message: root.import_error_message;
            show_error: root.show_import_error;
            import_pressed(key) => {
                root.import_key_attempt(key);
            }
            cancel_pressed => {
                root.cancel_import();
            }
        }

        // Key display (after successful generation or import)
        VerticalLayout {
            visible: root.current_view == "key-display";
            padding: 32px;
            spacing: 16px;

            Text {
                text: "Your Cryptographic Identity";
                font-size: 24px;
                color: #ffffff;
                font-weight: 700;
            }

            KeyDisplay {
                public_key: root.public_key_display;
                show_label: true;
                allow_copy: true;
                show_copy_feedback: root.copy_feedback_visible;
                copy_pressed => {
                    root.copy_public_key();
                }
            }

            Text {
                visible: root.status_message != "";
                text: root.status_message;
                font-size: 12px;
                color: root.status_is_error ? #ff4444 : #4cd137;
            }

            Text {
                text: "Ready to connect and send messages";
                font-size: 12px;
                color: #999999;
            }
        }

            // Lobby view (Story 2.2 - Online User List)
            VerticalLayout {
                visible: root.current_view == "lobby";
                padding: 16px;
                spacing: 8px;

                Text {
                    text: "Online Users";
                    font-size: 18px;
                    color: #ffffff;
                    font-weight: 600;
                }

                Text {
                    visible: root.lobby_user_count == 0;
                    text: "No users online";
                    font-size: 14px;
                    color: #999999;
                    height: 100px;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }

                // Lobby list container (fixed slots for up to 5 users)
                // Note: Slint 1.5 doesn't support dynamic for-each loops,
                // so we use fixed slots with visibility control.
                Rectangle {
                    visible: root.lobby_user_count > 0;
                    background: #111827;
                    border-radius: 4px;
                    height: 400px;

                    VerticalLayout {
                        padding: 8px;

                        // Lobby user slots (up to 5 users for MVP)
                        // Each slot is bound to Rust-side properties
                        // Slot 1
                        LobbyItem {
                            visible: root.lobby_user_count >= 1;
                            public_key: root.lobby_user_1_public_key;
                            is_online: root.lobby_user_1_online;
                            is_selected: root.lobby_user_1_selected;
                            clicked => {
                                root.lobby_user_selected(root.lobby_user_1_public_key);
                            }
                        }

                        // Slot 2
                        LobbyItem {
                            visible: root.lobby_user_count >= 2;
                            public_key: root.lobby_user_2_public_key;
                            is_online: root.lobby_user_2_online;
                            is_selected: root.lobby_user_2_selected;
                            clicked => {
                                root.lobby_user_selected(root.lobby_user_2_public_key);
                            }
                        }

                        // Slot 3
                        LobbyItem {
                            visible: root.lobby_user_count >= 3;
                            public_key: root.lobby_user_3_public_key;
                            is_online: root.lobby_user_3_online;
                            is_selected: root.lobby_user_3_selected;
                            clicked => {
                                root.lobby_user_selected(root.lobby_user_3_public_key);
                            }
                        }

                        // Slot 4
                        LobbyItem {
                            visible: root.lobby_user_count >= 4;
                            public_key: root.lobby_user_4_public_key;
                            is_online: root.lobby_user_4_online;
                            is_selected: root.lobby_user_4_selected;
                            clicked => {
                                root.lobby_user_selected(root.lobby_user_4_public_key);
                            }
                        }

                        // Slot 5
                        LobbyItem {
                            visible: root.lobby_user_count >= 5;
                            public_key: root.lobby_user_5_public_key;
                            is_online: root.lobby_user_5_online;
                            is_selected: root.lobby_user_5_selected;
                            clicked => {
                                root.lobby_user_selected(root.lobby_user_5_public_key);
                            }
                        }
                    }
                }

                Text {
                    visible: root.lobby_selected_user != "";
                    text: "Selected: " + root.lobby_selected_user;
                    font-size: 12px;
                    color: #0066CC;
                }

                // Message composer (Story 2.2 - placeholder, full chat in Story 3.x)
                MessageComposer {
                    recipient: root.lobby_selected_user;
                    focused: root.composer_focused;
                }
            }
    }
}
